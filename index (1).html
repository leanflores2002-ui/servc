<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Facturas con Notificaciones</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
</head>
<body class="bg-gradient-to-r from-blue-200 via-purple-200 to-pink-200 min-h-screen flex items-center justify-center">
  <div class="container mx-auto p-6 max-w-5xl">
    <h1 class="text-4xl font-extrabold text-center text-indigo-800 mb-4 drop-shadow-md">Gestor de Facturas Pendientes</h1>
    <p id="currentDateTime" class="text-center text-lg text-indigo-600 mb-8">Fecha actual: Cargando...</p>
    
    <!-- Formulario para agregar factura -->
    <div class="bg-white p-8 rounded-xl shadow-2xl mb-8 border border-indigo-200">
      <h2 class="text-2xl font-bold text-indigo-700 mb-6">Agregar Factura Pagada</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input id="serviceName" type="text" placeholder="Nombre del servicio (ej. Luz)" class="p-3 border-2 border-indigo-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-400 text-lg">
        <input id="lastPaidDate" type="date" max="2025-08-07" class="p-3 border-2 border-indigo-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-400 text-lg">
        <input id="amount" type="number" placeholder="Monto ($)" step="0.01" min="0.01" class="p-3 border-2 border-indigo-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-400 text-lg">
        <input id="billingCycle" type="number" placeholder="Ciclo (días)" value="30" min="1" class="p-3 border-2 border-indigo-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-400 text-lg">
      </div>
      <div class="mt-6">
        <label class="block text-lg font-medium text-indigo-700">Ubicación:</label>
        <select id="location" class="p-3 border-2 border-indigo-300 rounded-lg w-full focus:outline-none focus:ring-4 focus:ring-indigo-400 text-lg">
          <option value="Hogar">Hogar</option>
          <option value="Oficina">Oficina</option>
          <option value="Negocio">Negocio</option>
          <option value="Otro">Otro</option>
        </select>
      </div>
      <div class="mt-6">
        <label class="block text-lg font-medium text-indigo-700">Notificar por:</label>
        <div class="flex items-center space-x-4">
          <div>
            <input type="checkbox" id="notifyWhatsApp" class="h-5 w-5 text-green-500 focus:ring-green-400"><span class="ml-2 text-indigo-600">WhatsApp</span>
          </div>
          <div>
            <input type="checkbox" id="notifyEmail" class="h-5 w-5 text-green-500 focus:ring-green-400"><span class="ml-2 text-indigo-600">Correo</span>
          </div>
        </div>
      </div>
      <button id="addBill" class="mt-6 bg-indigo-600 text-white px-8 py-4 rounded-lg text-xl font-semibold hover:bg-indigo-700 transition shadow-lg">Agregar Factura</button>
    </div>

    <!-- Lista de facturas -->
    <div id="billsList" class="space-y-6">
      <h2 class="text-2xl font-bold text-indigo-700">Facturas Próximas</h2>
      <div id="notifications" class="space-y-2"></div>
      <div id="billsContainer" class="space-y-4"></div>
    </div>
  </div>

  <script>
    // Inicializar EmailJS (reemplaza con tu USER_ID de EmailJS)
    emailjs.init("TU_EMAILJS_USER_ID");

    // Configuración de contactos predefinidos
    const WHATSAPP_NUMBER = "TU_NUMERO_WHATSAPP"; // ej. +549123456789
    const EMAIL_ADDRESS = "TU_CORREO_ELECTRONICO"; // ej. usuario@ejemplo.com

    // Mostrar fecha y hora actuales
    function updateDateTime() {
      const now = new Date();
      now.setTime(now.getTime() - 3 * 60 * 60 * 1000); // Ajustar a UTC-3
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'America/Argentina/Buenos_Aires'
      };
      document.getElementById('currentDateTime').textContent = `Fecha actual: ${now.toLocaleString('es-AR', options)}`;
    }
    updateDateTime();
    setInterval(updateDateTime, 60 * 1000); // Actualizar cada minuto

    // Cargar facturas desde localStorage
    let bills = JSON.parse(localStorage.getItem('bills')) || [];

    // Función para guardar facturas en localStorage
    function saveBills() {
      localStorage.setItem('bills', JSON.stringify(bills));
    }

    // Función para calcular la próxima fecha de vencimiento
    function calculateNextDueDate(lastPaidDate, billingCycle) {
      const date = new Date(lastPaidDate);
      date.setDate(date.getDate() + parseInt(billingCycle));
      return date.toISOString().split('T')[0];
    }

    // Función para calcular días hasta la fecha de vencimiento
    function daysUntilDue(date) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      today.setTime(today.getTime() - 3 * 60 * 60 * 1000); // Ajustar a UTC-3
      const dueDate = new Date(date);
      dueDate.setHours(0, 0, 0, 0);
      const diffTime = dueDate - today;
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // Función para enviar notificación por WhatsApp (usando Twilio)
    async function sendWhatsAppNotification(message) {
      try {
        const response = await fetch('https://api.twilio.com/2010-04-01/Accounts/TU_TWILIO_SID/Messages.json', {
          method: 'POST',
          headers: {
            'Authorization': 'Basic ' + btoa('TU_TWILIO_SID:TU_TWILIO_AUTH_TOKEN'),
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            'To': `whatsapp:${WHATSAPP_NUMBER}`,
            'From': 'whatsapp:TU_TWILIO_WHATSAPP_NUMBER',
            'Body': message
          })
        });
        if (response.ok) {
          console.log('Notificación por WhatsApp enviada');
        } else {
          console.error('Error al enviar WhatsApp:', await response.text());
        }
      } catch (error) {
        console.error('Error en WhatsApp:', error);
      }
    }

    // Función para enviar notificación por correo (usando EmailJS)
    function sendEmailNotification(message) {
      emailjs.send('TU_EMAILJS_SERVICE_ID', 'TU_EMAILJS_TEMPLATE_ID', {
        to_email: EMAIL_ADDRESS,
        message: message
      }).then(
        () => console.log('Notificación por correo enviada'),
        (error) => console.error('Error al enviar correo:', error)
      );
    }

    // Función para renderizar las facturas
    function renderBills() {
      const billsContainer = document.getElementById('billsContainer');
      const notificationsContainer = document.getElementById('notifications');
      billsContainer.innerHTML = '';
      notificationsContainer.innerHTML = '';

      bills.forEach((bill, index) => {
        const daysLeft = daysUntilDue(bill.nextDueDate);
        let statusColor = 'bg-green-200';
        let statusText = `Vence en ${daysLeft} días`;
        let notificationMessage = '';
        let shouldNotify = false;

        // Inicializar banderas de notificación si no existen
        bill.notified7Days = bill.notified7Days || false;
        bill.notified3Days = bill.notified3Days || false;
        bill.notifiedOverdue = bill.notifiedOverdue || false;

        if (daysLeft < 0 && !bill.notifiedOverdue) {
          statusColor = 'bg-red-200';
          statusText = `Vencida hace ${Math.abs(daysLeft)} días`;
          notificationMessage = `🚨 ¡Alerta! La factura de ${bill.name} (${bill.location}) está vencida hace ${Math.abs(daysLeft)} días. Monto: $${parseFloat(bill.amount).toFixed(2)}.`;
          shouldNotify = true;
          bill.notifiedOverdue = true;
        } else if (daysLeft === 3 && !bill.notified3Days) {
          statusColor = 'bg-yellow-200';
          statusText = `Vence en ${daysLeft} días`;
          notificationMessage = `⚠️ ¡Atención! La factura de ${bill.name} (${bill.location}) vence en ${daysLeft} días. Monto: $${parseFloat(bill.amount).toFixed(2)}.`;
          shouldNotify = true;
          bill.notified3Days = true;
        } else if (daysLeft === 7 && !bill.notified7Days) {
          statusColor = 'bg-yellow-200';
          statusText = `Vence en ${daysLeft} días`;
          notificationMessage = `🔔 Recordatorio: La factura de ${bill.name} (${bill.location}) vence en ${daysLeft} días. Monto: $${parseFloat(bill.amount).toFixed(2)}.`;
          shouldNotify = true;
          bill.notified7Days = true;
        }

        // Mostrar y enviar notificaciones
        if (notificationMessage) {
          const notification = document.createElement('div');
          notification.className = `p-3 rounded-lg ${daysLeft < 0 ? 'bg-red-600' : 'bg-yellow-600'} text-white text-lg font-medium shadow-md`;
          notification.textContent = notificationMessage;
          notificationsContainer.appendChild(notification);

          if (shouldNotify) {
            if (bill.notifyWhatsApp) {
              sendWhatsAppNotification(notificationMessage);
            }
            if (bill.notifyEmail) {
              sendEmailNotification(notificationMessage);
            }
          }
        }

        const billElement = document.createElement('div');
        billElement.className = `p-6 rounded-xl shadow-lg ${statusColor} flex justify-between items-center border border-indigo-100`;
        billElement.innerHTML = `
          <div>
            <h3 class="text-xl font-semibold text-indigo-800">${bill.name}</h3>
            <p class="text-indigo-600">Monto: $${parseFloat(bill.amount).toFixed(2)}</p>
            <p class="text-indigo-600">Ubicación: ${bill.location}</p>
            <p class="text-indigo-600">Última factura pagada: ${new Date(bill.lastPaidDate).toLocaleDateString('es-ES')}</p>
            <p class="text-indigo-600">Próximo vencimiento: ${new Date(bill.nextDueDate).toLocaleDateString('es-ES')}</p>
            <p class="text-indigo-600">${statusText}</p>
            <p class="text-indigo-600">Notificar por: ${bill.notifyWhatsApp ? 'WhatsApp ' : ''}${bill.notifyEmail ? 'Correo' : ''}</p>
          </div>
          <button class="bg-red-600 text-white px-8 py-4 rounded-lg text-xl font-semibold hover:bg-red-700 transition shadow-lg" onclick="deleteBill(${index})">Eliminar</button>
        `;
        billsContainer.appendChild(billElement);
      });

      saveBills(); // Guardar cambios en las banderas de notificación
    }

    // Función para agregar una factura
    document.getElementById('addBill').addEventListener('click', () => {
      const name = document.getElementById('serviceName').value;
      const lastPaidDate = document.getElementById('lastPaidDate').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const billingCycle = parseInt(document.getElementById('billingCycle').value);
      const location = document.getElementById('location').value;
      const notifyWhatsApp = document.getElementById('notifyWhatsApp').checked;
      const notifyEmail = document.getElementById('notifyEmail').checked;

      const today = new Date();
      today.setTime(today.getTime() - 3 * 60 * 60 * 1000); // Ajustar a UTC-3
      const paidDate = new Date(lastPaidDate);

      if (name && lastPaidDate && amount > 0 && billingCycle > 0 && location && (notifyWhatsApp || notifyEmail)) {
        if (paidDate > today) {
          alert('La fecha de última factura pagada no puede ser futura.');
          return;
        }
        const nextDueDate = calculateNextDueDate(lastPaidDate, billingCycle);
        bills.push({
          name,
          lastPaidDate,
          amount,
          billingCycle,
          location,
          nextDueDate,
          notifyWhatsApp,
          notifyEmail,
          notified7Days: false,
          notified3Days: false,
          notifiedOverdue: false
        });
        saveBills();
        renderBills();
        // Limpiar formulario
        document.getElementById('serviceName').value = '';
        document.getElementById('lastPaidDate').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('billingCycle').value = '30';
        document.getElementById('location').value = 'Hogar';
        document.getElementById('notifyWhatsApp').checked = false;
        document.getElementById('notifyEmail').checked = false;
      } else {
        alert('Por favor, completa todos los campos con valores válidos y selecciona al menos un método de notificación.');
      }
    });

    // Función para eliminar una factura
    function deleteBill(index) {
      bills.splice(index, 1);
      saveBills();
      renderBills();
    }

    // Renderizar facturas al cargar la página
    renderBills();

    // Verificar vencimientos cada hora
    setInterval(renderBills, 60 * 60 * 1000);
  </script>
</body>
</html>